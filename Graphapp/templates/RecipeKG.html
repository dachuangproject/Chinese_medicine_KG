{% extends 'base.html' %}
{% load static %}
{% block title %}方剂知识图谱{% endblock %}
{% block content %}
    <br>
        <div class="container-fluid">
            <!-- Page Header-->
            <header>
                <h1 class="h3 display">方剂知识图谱</h1>
            </header>
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                             <form action="{% url 'Recipeindex' %}" method="get">
                            <div class="form-group row" style="margin-left: 300px;" >
                                <label class="form-control-label" >方剂名称</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="search-recipeKG-text"  style="vertical-align: middle;">
                                </div>
                                <div class="col-sm-2 " style="text-align: right;">
                                    <button class="btn btn-primary" id="button">检索</button>
                                </div>
                            </div>
                             </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" id="show">
                <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
                <script src="https://d3js.org/d3.v4.min.js"></script>
                <div class="col-lg-12">
                   <div class="card">
                      <div class="card-body" >
                         <div id="id1">
                             <script type="text/javascript">
                                var height=600;
                                    var width=1050;

                                    var colors = ['#6ca46c', '#4e88af', '#ca635f', '#d2907c', '#d6744d', '#ded295'];

                                    var colors_text=['#404040'];//文本颜色

                                    var colors_links=['#404040'];//线颜色

                                    var svg=d3.select("#id1")
                                        .append("svg")
                                        .attr("width",width)
                                        .attr("height",height);

{#                                  利用d3.forceSimulation()定义关系图 包括设置边link、排斥电荷charge,strength表示节点距离、关系图中心点#}
                                    var simulation = d3.forceSimulation()
	                                    .force("link", d3.forceLink().id(function(d) {
	                                        return d.id;
	                                    }))
	                                    .force("charge", d3.forceManyBody().strength(-700))
	                                    .force("center", d3.forceCenter(width / 2, height / 2));

{#                                  存储关系图的数据#}
	                                var graph={{ arg | safe }};


                                    //D3映射数据至HTML中
	    	                        //g用于绘制所有边,selectALL选中所有的line,并绑定数据data(graph.links),enter().append("line")添加元素
	    	                        //数据驱动文档,设置边的粗细
                                    //所有线宽度均为3
	    	                        var link = svg.append("g").attr("class","links").selectAll("line").data(graph.links).enter()
	    	                        .append("line").attr("stroke-width", function(d) {
	    		                        //return Math.sqrt(d.value);
	    		                        return 3;
	    	                        }).attr("stroke", function() {
	    		                        return colors_links;
	    	                        })


                                    //添加所有的点
	    	                        //selectAll("circle")选中所有的圆并绑定数据,圆的直径为d.size
	    	                        //再定义圆的填充色,同样数据驱动样式,圆没有描边,圆的名字为d.id
	    	                        //call()函数：拖动函数,当拖动开始绑定dragstarted函数，拖动进行和拖动结束也绑定函数
	    	                        var node = svg.append("g").attr("class", "nodes").selectAll("circle").data(graph.nodes).enter()
	    	                        .append("circle").attr("r", function(d) {
	    		                        return d.size;
	    	                        }).attr("fill", function(d) {
	    		                        return colors[d.group];
	    	                        }).attr("stroke", "none").attr("name", function(d) {
	    		                        return d.id;
	    	                        }).call(d3.drag()
	    		                        .on("start", dragstarted)
	    		                        .on("drag", dragged)
	    		                        .on("end", dragended)
	    	                        );

                                    //显示所有的文本
                                    //设置大小、填充颜色、名字、text()设置文本
                                    //attr("text-anchor", "middle")文本居中

                                    var text = svg.append("g").attr("class", "texts").selectAll("text").data(graph.nodes).enter()
                                    .append("text").attr("font-size", function(d) {
                                        return 15;
                                    }).attr("fill", function() {
                                        return colors_text;
                                    }).attr('name', function(d) {
                                        return d.id;
                                    }).text(function(d) {
                                        return d.id;
                                    }).call(d3.drag()
                                        .on("start", dragstarted)
                                        .on("drag", dragged)
                                        .on("end", dragended)
                                    );


                                        //圆增加title
                                    node.append("title").text(function(d) {
                                            return d.id;
                                        })

                                        //simulation
                                        //ticked 数据初始化，并生成图形

                                        simulation
                                            .nodes(graph.nodes)
                                            .on("tick", ticked);

                                        simulation.force("link")
                                            .links(graph.links);


                                        //开始拖动并更新相应的点
	                                function dragstarted(d) {
	                                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                                        d.fx = d.x;
	                                    d.fy = d.y;
                                        //dragging = true;
	                                }

	                                //拖动进行中
	                                function dragged(d) {
	                                    d.fx = d3.event.x;
	                                    d.fy = d3.event.y;
	                                }

	                                //拖动结束
                                    function dragended(d) {
	                                    if (!d3.event.active) simulation.alphaTarget(0);
	                                    d.fx = null;
	                                    d.fy = null;
	                                    //dragging = false;
	                                }

{#                                    var dataset={#}
{#                                        nodes:[{ name:"软坚清脉颗粒"},{ name:"海藻"},{ name:"牡蛎"},{ name:"蒲黄"},{ name:"垂盆草"},{ name:"豨莶草"},#}
{#                                            { name:"降脂"},{ name:"软坚散结"},{ name:"止血化瘀"},{ name:"清热利湿"},{ name:"祛风湿"}],#}
{##}
{#                                        edges:[{ source:0,target:1,weight:5},{ source:0,target:2,weight:5},{ source:0,target:3,weight:5},{ source:0,target:4,weight:5},{ source:0,target:5,weight:5},{ source:1,target:6,weight:5},{ source:2,target:7,weight:5},#}
{#                                            { source:3,target:8,weight:5},{ source:4,target:9,weight:5},{source:5,target:10,weight:5}]#}
{#                                    };#}


{#                                    var nodes=svg.selectAll("circle")#}
{#                                        .data(dataset.nodes)#}
{#                                        .enter()#}
{#                                        .append("circle")#}
{#                                        .attr("r",function(d,i){#}
{#                                            if(i==0)#}
{#                                            {#}
{#                                                r=30;#}
{#                                            }#}
{#                                            else#}
{#                                            {#}
{#                                                r=20;#}
{#                                            }#}
{#                                            return r;#}
{#                                        })#}
{#                                        .style("fill",function(d,i){#}
{#                                            if(i==0)#}
{#                                            {#}
{#                                                c=12;#}
{#                                            }#}
{#                                            else#}
{#                                            {#}
{#                                                c=10;#}
{#                                            }#}
{#                                            return colors(c);#}
{#                                        })#}
{#                                        //单击节点显示详情#}
{#                                        .on("dblclick",function(d,i){#}
{#                                            if(i>0)#}
{#                                                window.location=d.name+".html"#}
{#                                        })#}
{#                                        .call(force.drag);#}

                                    //tick()函数确定link线的起始点x、y坐标 node确定中心点 文本通过translate平移变化
                                        function ticked() {
                                    link
                                        .attr("x1", function(d) {
                                            return d.source.x;
                                        })
                                        .attr("y1", function(d) {
                                            return d.source.y;
                                        })
                                        .attr("x2", function(d) {
                                            return d.target.x;
                                        })
                                        .attr("y2", function(d) {
                                            return d.target.y;
                                        });

                                    node
                                        .attr("cx", function(d) {
                                            return d.x;
                                        })
                                        .attr("cy", function(d) {
                                            return d.y;
                                        });

                                    text.
                                    attr('transform', function(d) {
                                        return 'translate(' + d.x + ',' + (d.y + d.size / 2) + ')';
                                    });
                                }
                            </script>
                             </div>
                          </div>
                       </div>
                    </div>
{#                <div class="col-lg-4">#}
{#                    <div class="card">#}
{#                        <div class="card-body">#}
{#                            <div  style="height:600px;">#}
{#                                <h1>垂盆草</h1>#}
{#                                <p style="font-size: 15px">【中文拼音名】Chuipencao</p>#}
{#                                <p style="font-size: 15px">【拉丁名】Sedi Herba</p>#}
{#                                <p style="font-size: 15px">【类别】</p>#}
{#                                <img src="img/cpc.jpg" width="200" height="150">#}
{#                                <br>#}
{#                                <p><div style="color:black">【简介】垂盆草属于凉性，所以能够清除体热利于湿气的排出，还能凉血止血。垂盆草可以降低血清转氨酶，可以减轻口苦、食欲不好、小便赤黄等湿热等症状。</p>#}
{#                                   </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
                </div>
            </div>
{% endblock %}


